{# rsvp/templates/rsvp/rsvp_form.html #}
{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}RSVP for the Wedding{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center"> {# Added row and col for better centering/layout #}
        <div class="col-md-9 col-lg-8"> {# Adjust column size as needed #}
            <h2 class="text-center mb-4 section-title">RSVP for the Wedding</h2>

            {# Display Django Messages (success/error/info) #}
            {% if messages %}
                <div class="messages mb-4"> {# Wrapped messages in a div #}
                    {% for message in messages %}
                        <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags == 'success' %}success{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <form method="post">
                {% csrf_token %}

                {# Main RSVP Form Fields #}
                <div class="card p-4 mb-4 shadow-sm">
                    <h4 class="card-title mb-3">Your RSVP Details</h4>
                    {# --- CHANGE 1: Apply crispy filter to the main rsvp_form --- #}
                    {{ rsvp_form|crispy }}
                    {# Non-field errors are handled by crispy if you use |crispy #}
                </div>

                {# Guest Formset Section #}
                <div class="card p-4 shadow-sm">
                    <h4 class="card-title mb-3">Your Party Details (Guests)</h4>

                    {{ guest_formset.management_form }}

                    <div id="guest-formset-container">
                        {% for form in guest_formset %}
                            <div class="guest-form-row mb-4 p-3 border rounded" id="form-{{ forloop.counter0 }}">
                                <h5 class="guest-form-header">Guest #<span class="guest-number">{{ forloop.counter }}</span></h5>
                                {# --- CHANGE 2: Apply crispy filter to each form in the formset --- #}
                                {{ form|crispy }}
                                {# No need for individual field loops when using |crispy #}
                                {# No need for non_field_errors loop when using |crispy #}

                                {# If you want a specific button to remove guests within the row #}
                                {% if guest_formset.can_delete and form.instance.pk %} {# Only show remove for existing guests #}
                                <button type="button" class="btn btn-sm btn-outline-danger remove-guest-button mt-2" data-form-id="{{ form.prefix }}">Remove this Guest</button>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>

                    <button type="button" id="add-guest-button" class="btn btn-wedding-secondary mt-3">Add Another Guest</button>
                </div>

                <button type="submit" class="btn btn-wedding-primary btn-lg w-100 mt-4">Submit RSVP</button>
            </form>
        </div>
    </div>
</div>

{% endblock content %}

{# JavaScript for dynamic formsets #}
{% block scripts %}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const addGuestButton = document.getElementById('add-guest-button');
        const formsetContainer = document.getElementById('guest-formset-container');
        const totalFormsInput = document.querySelector('input[name="guests-TOTAL_FORMS"]');
        const emptyFormTemplate = document.getElementById('empty-form-template'); // New: for the template

        let formIdx = parseInt(totalFormsInput.value);

        addGuestButton.addEventListener('click', function() {
            // Clone the template empty form
            const newForm = emptyFormTemplate.cloneNode(true);
            newForm.id = `form-${formIdx}`; // Assign a unique ID
            newForm.style.display = 'block'; // Make it visible

            // Replace '__prefix__' with the new formIdx
            newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formIdx);

            // Update guest number display
            const guestNumberSpan = newForm.querySelector('.guest-number');
            if (guestNumberSpan) {
                guestNumberSpan.textContent = formIdx + 1;
            }

            // Append to container
            formsetContainer.appendChild(newForm);

            // Update the TOTAL_FORMS count
            formIdx++;
            totalFormsInput.value = formIdx;
        });

        // Handle removing existing guests
        formsetContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-guest-button')) {
                const button = event.target;
                const formPrefix = button.dataset.formId; // e.g., guests-0, guests-1
                const formRow = button.closest('.guest-form-row');
                
                if (formRow) {
                    const deleteCheckbox = formRow.querySelector(`input[name="${formPrefix}-DELETE"]`);
                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true; // Mark for deletion
                        formRow.style.display = 'none'; // Hide the form row
                    }
                }
            }
        });

        // Initial numbering for existing forms
        formsetContainer.querySelectorAll('.guest-form-row').forEach((row, index) => {
            const guestNumberSpan = row.querySelector('.guest-number');
            if (guestNumberSpan) {
                guestNumberSpan.textContent = index + 1;
            }
        });
    });
</script>
{% endblock scripts %}

{% block extra_body %}
{# Hidden template for new guest forms (rendered by crispy) #}
<div id="empty-form-template" style="display: none;">
    <div class="guest-form-row mb-4 p-3 border rounded">
        <h5 class="guest-form-header">Guest #<span class="guest-number"></span></h5>
        {# This part needs to be rendered using crispy's template pack in your view or here #}
        {# For simplicity, you can initially put the raw HTML for a crispy-styled form part here. #}
        {# Ideally, you'd render {{ guest_formset.empty_form|crispy }} in your view and pass it here. #}
        {# For now, let's include the raw Crispy output if you don't adjust the view. #}
        {# You'll need to fetch the crispy rendering of an empty form. #}

        {# A simplified placeholder for crispy-style field, you might need to adjust based on your crispy version and exact setup #}
        {# This is a common structure that Crispy Forms uses #}
        <div class="mb-3">
            <label for="id_guests-__prefix__-name" class="form-label requiredField">Guest Name<span class="asteriskField">*</span></label>
            <input type="text" name="guests-__prefix__-name" maxlength="100" class="textinput textInput form-control" required id="id_guests-__prefix__-name">
        </div>
        <div class="mb-3">
            <label for="id_guests-__prefix__-age" class="form-label">Guest Age</label>
            <input type="number" name="guests-__prefix__-age" class="numberinput form-control" id="id_guests-__prefix__-age">
        </div>
        <div class="mb-3">
            <label for="id_guests-__prefix__-dietary_restrictions" class="form-label">Dietary Restrictions</label>
            <textarea name="guests-__prefix__-dietary_restrictions" cols="40" rows="2" class="textarea form-control" id="id_guests-__prefix__-dietary_restrictions"></textarea>
        </div>
        <div class="mb-3">
            <label for="id_guests-__prefix__-favorite_song" class="form-label">Favorite Song</label>
            <input type="text" name="guests-__prefix__-favorite_song" maxlength="200" class="textinput textInput form-control" id="id_guests-__prefix__-favorite_song">
        </div>
        
        {# Hidden DELETE checkbox for new forms (will be unchecked) #}
        <div class="form-check mt-2" style="display: none;">
            <input type="checkbox" name="guests-__prefix__-DELETE" id="id_guests-__prefix__-DELETE" class="form-check-input">
            <label class="form-check-label" for="id_guests-__prefix__-DELETE">Remove this Guest</label>
        </div>
    </div>
</div>
{% endblock extra_body %}