{# rsvp/templates/rsvp/rsvp_form.html #}
{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}RSVP for the Wedding{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center"> {# Added row and col for better centering/layout #}
        <div class="col-md-9 col-lg-8"> {# Adjust column size as needed #}
            <h2 class="text-center mb-4 section-title">RSVP for the Wedding</h2>

            {# Display Django Messages (success/error/info) #}
            {% if messages %}
                <div class="messages mb-4"> {# Wrapped messages in a div #}
                    {% for message in messages %}
                        <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags == 'success' %}success{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <form method="post">
                {% csrf_token %}
                {{ rsvp_form|crispy }}
                {{ guest_formset.management_form }}
                <div id="guest-formset-container">
                    {% for form in guest_formset %}
                        <div class="guest-form-row mb-4 p-3 border rounded">
                            {{ form|crispy }}
                            <button type="button" class="remove-guest-button btn btn-danger btn-sm">Remove</button>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-guest-button" class="btn btn-secondary mt-3">Add Another Guest</button>
                <button type="submit" class="btn btn-wedding-primary btn-lg w-100 mt-4">Submit RSVP</button>
            </form>

            <!-- Hidden template for new guest forms -->
            <div id="empty-form-template" style="display: none;">
                {{ guest_formset.empty_form|crispy }}
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{# JavaScript for dynamic formsets #}
{% block scripts %}
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    const addGuestButton = document.getElementById('add-guest-button');
    const formsetContainer = document.getElementById('guest-formset-container');
    const totalFormsInput = document.querySelector('input[name="guests-TOTAL_FORMS"]');
    const emptyFormTemplate = document.getElementById('empty-form-template');

    function updateRemoveButtons() {
        formsetContainer.querySelectorAll('.remove-guest-button').forEach(btn => {
            btn.onclick = function() {
                const row = btn.closest('.guest-form-row');
                if (row) {
                    // If there's a DELETE checkbox, check it and hide the row
                    const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true;
                        row.style.display = 'none';
                    } else {
                        // Otherwise, remove the row and update TOTAL_FORMS
                        row.remove();
                        totalFormsInput.value = formsetContainer.querySelectorAll('.guest-form-row').length;
                    }
                }
            };
        });
    }

    addGuestButton.addEventListener('click', function() {
        let formIdx = parseInt(totalFormsInput.value);
        const newForm = emptyFormTemplate.cloneNode(true);
        newForm.id = `form-${formIdx}`;
        newForm.style.display = 'block';
        newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formIdx);
        newForm.classList.add('guest-form-row', 'mb-4', 'p-3', 'border', 'rounded');
        formsetContainer.appendChild(newForm);
        totalFormsInput.value = formIdx + 1;
        updateRemoveButtons();
    });

    updateRemoveButtons();
});
</script>
{% endblock scripts %}

{% block extra_body %}
{% endblock extra_body %}